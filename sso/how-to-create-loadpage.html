<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>落地页生成 | Wiki文档中心</title>
    <meta name="description" content="描述">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.4d8ba4a7.css" as="style"><link rel="preload" href="/assets/js/app.3328e81d.js" as="script"><link rel="preload" href="/assets/js/2.c715c0f2.js" as="script"><link rel="preload" href="/assets/js/61.70db4cce.js" as="script"><link rel="prefetch" href="/assets/js/10.abfcde09.js"><link rel="prefetch" href="/assets/js/11.3ee26f26.js"><link rel="prefetch" href="/assets/js/12.45406b92.js"><link rel="prefetch" href="/assets/js/13.7aa97305.js"><link rel="prefetch" href="/assets/js/14.34708031.js"><link rel="prefetch" href="/assets/js/15.76570f77.js"><link rel="prefetch" href="/assets/js/16.29d4e7cd.js"><link rel="prefetch" href="/assets/js/17.eda984dd.js"><link rel="prefetch" href="/assets/js/18.1bb9f9b9.js"><link rel="prefetch" href="/assets/js/19.231ae034.js"><link rel="prefetch" href="/assets/js/20.26a455ac.js"><link rel="prefetch" href="/assets/js/21.62f18186.js"><link rel="prefetch" href="/assets/js/22.177e8b0f.js"><link rel="prefetch" href="/assets/js/23.60274af5.js"><link rel="prefetch" href="/assets/js/24.0ea00a49.js"><link rel="prefetch" href="/assets/js/25.3d5be951.js"><link rel="prefetch" href="/assets/js/26.19229e66.js"><link rel="prefetch" href="/assets/js/27.6d99c0ab.js"><link rel="prefetch" href="/assets/js/28.d28de4e0.js"><link rel="prefetch" href="/assets/js/29.29379faf.js"><link rel="prefetch" href="/assets/js/3.90a63800.js"><link rel="prefetch" href="/assets/js/30.9fe6691b.js"><link rel="prefetch" href="/assets/js/31.2c753b40.js"><link rel="prefetch" href="/assets/js/32.b87ed25b.js"><link rel="prefetch" href="/assets/js/33.69099052.js"><link rel="prefetch" href="/assets/js/34.fb2e76ab.js"><link rel="prefetch" href="/assets/js/35.41f3d46b.js"><link rel="prefetch" href="/assets/js/36.78adf827.js"><link rel="prefetch" href="/assets/js/37.6cb8f1dc.js"><link rel="prefetch" href="/assets/js/38.3296535c.js"><link rel="prefetch" href="/assets/js/39.852ec6ec.js"><link rel="prefetch" href="/assets/js/4.338175e6.js"><link rel="prefetch" href="/assets/js/40.4f030cd4.js"><link rel="prefetch" href="/assets/js/41.7b948635.js"><link rel="prefetch" href="/assets/js/42.7038bdd7.js"><link rel="prefetch" href="/assets/js/43.09ba85b3.js"><link rel="prefetch" href="/assets/js/44.30c43542.js"><link rel="prefetch" href="/assets/js/45.7fc52c71.js"><link rel="prefetch" href="/assets/js/46.e57513f1.js"><link rel="prefetch" href="/assets/js/47.79ad04e1.js"><link rel="prefetch" href="/assets/js/48.806e5af9.js"><link rel="prefetch" href="/assets/js/49.1e083288.js"><link rel="prefetch" href="/assets/js/5.15ce4230.js"><link rel="prefetch" href="/assets/js/50.eef1990e.js"><link rel="prefetch" href="/assets/js/51.cdde33a8.js"><link rel="prefetch" href="/assets/js/52.bcb09293.js"><link rel="prefetch" href="/assets/js/53.87c2baec.js"><link rel="prefetch" href="/assets/js/54.4d9707e7.js"><link rel="prefetch" href="/assets/js/55.5fb2a242.js"><link rel="prefetch" href="/assets/js/56.63b1cb46.js"><link rel="prefetch" href="/assets/js/57.4108fa62.js"><link rel="prefetch" href="/assets/js/58.38c656c4.js"><link rel="prefetch" href="/assets/js/59.2e9da043.js"><link rel="prefetch" href="/assets/js/6.4db8bcb4.js"><link rel="prefetch" href="/assets/js/60.62a9603a.js"><link rel="prefetch" href="/assets/js/62.c0b27237.js"><link rel="prefetch" href="/assets/js/63.a1ff59d9.js"><link rel="prefetch" href="/assets/js/64.ba32929f.js"><link rel="prefetch" href="/assets/js/65.504fa9a6.js"><link rel="prefetch" href="/assets/js/66.39a7e2d4.js"><link rel="prefetch" href="/assets/js/67.409ffc00.js"><link rel="prefetch" href="/assets/js/68.21b084fc.js"><link rel="prefetch" href="/assets/js/69.1d10efe9.js"><link rel="prefetch" href="/assets/js/7.6832275b.js"><link rel="prefetch" href="/assets/js/70.0391f331.js"><link rel="prefetch" href="/assets/js/71.af289666.js"><link rel="prefetch" href="/assets/js/72.9a8504b0.js"><link rel="prefetch" href="/assets/js/73.0d35f166.js"><link rel="prefetch" href="/assets/js/74.75cd3652.js"><link rel="prefetch" href="/assets/js/75.53679119.js"><link rel="prefetch" href="/assets/js/76.5ea9dd36.js"><link rel="prefetch" href="/assets/js/77.95fe4c15.js"><link rel="prefetch" href="/assets/js/78.aaff367b.js"><link rel="prefetch" href="/assets/js/8.3662cfcf.js"><link rel="prefetch" href="/assets/js/9.a40092b3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4d8ba4a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Wiki文档中心" class="logo"> <span class="site-name can-hide">Wiki文档中心</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/introduce/" class="nav-link">指南</a></div><div class="nav-item"><a href="/sso/" class="nav-link router-link-active">单点登录</a></div><div class="nav-item"><a href="/seo/" class="nav-link">服务端渲染</a></div><div class="nav-item"><a href="/linux/" class="nav-link">Linux基础</a></div><div class="nav-item"><a href="/http/" class="nav-link">解读Http</a></div><div class="nav-item"><a href="/microfrontend/" class="nav-link">微前端</a></div><div class="nav-item"><a href="/weixin/" class="nav-link">微信全家桶</a></div><div class="nav-item"><a href="/performance/" class="nav-link">性能优化</a></div><div class="nav-item"><a href="/log/" class="nav-link">每日随笔</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/introduce/" class="nav-link">指南</a></div><div class="nav-item"><a href="/sso/" class="nav-link router-link-active">单点登录</a></div><div class="nav-item"><a href="/seo/" class="nav-link">服务端渲染</a></div><div class="nav-item"><a href="/linux/" class="nav-link">Linux基础</a></div><div class="nav-item"><a href="/http/" class="nav-link">解读Http</a></div><div class="nav-item"><a href="/microfrontend/" class="nav-link">微前端</a></div><div class="nav-item"><a href="/weixin/" class="nav-link">微信全家桶</a></div><div class="nav-item"><a href="/performance/" class="nav-link">性能优化</a></div><div class="nav-item"><a href="/log/" class="nav-link">每日随笔</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/sso/" class="sidebar-link">单点登录</a></li><li><a href="/sso/how-to-config-host.html" class="sidebar-link">Host 配置</a></li><li><a href="/sso/how-to-quickstart.html" class="sidebar-link">快速开始</a></li><li><a href="/sso/how-to-config-history.html" class="sidebar-link">History 路由</a></li><li><a href="/sso/how-to-use-dll.html" class="sidebar-link">Dll 动态链接库配置</a></li><li><a href="/sso/how-to-use-connect.html" class="sidebar-link">连接器的使用</a></li><li><a href="/sso/how-to-use-apollo.html" class="sidebar-link">Apollo 环境变量</a></li><li><a href="/sso/how-to-use-logout.html" class="sidebar-link">单点注销</a></li><li><a href="/sso/how-to-use-pm2.html" class="sidebar-link">PM2 部署</a></li><li><a href="/sso/how-to-use-docker.html" class="sidebar-link">Docker 部署</a></li><li><a href="/sso/how-to-use-pm2web.html" class="sidebar-link">PM2 性能监控</a></li><li><a href="/sso/how-to-create-loadpage.html" class="active sidebar-link">落地页生成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sso/how-to-create-loadpage.html#什么是落地页" class="sidebar-link">什么是落地页</a></li><li class="sidebar-sub-header"><a href="/sso/how-to-create-loadpage.html#输入输出是什么" class="sidebar-link">输入输出是什么</a></li><li class="sidebar-sub-header"><a href="/sso/how-to-create-loadpage.html#生成的具体思路" class="sidebar-link">生成的具体思路</a></li><li class="sidebar-sub-header"><a href="/sso/how-to-create-loadpage.html#技-术-栈" class="sidebar-link">技 术 栈</a></li><li class="sidebar-sub-header"><a href="/sso/how-to-create-loadpage.html#项目结构" class="sidebar-link">项目结构</a></li><li class="sidebar-sub-header"><a href="/sso/how-to-create-loadpage.html#依赖模块" class="sidebar-link">依赖模块</a></li><li class="sidebar-sub-header"><a href="/sso/how-to-create-loadpage.html#vue-项目搭建" class="sidebar-link">vue 项目搭建</a></li><li class="sidebar-sub-header"><a href="/sso/how-to-create-loadpage.html#koa-项目搭建" class="sidebar-link">koa 项目搭建</a></li><li class="sidebar-sub-header"><a href="/sso/how-to-create-loadpage.html#更-多" class="sidebar-link">更 多</a></li></ul></li><li><a href="/sso/what-about-on-webpack-update.html" class="sidebar-link">webpack 2.x 升级到 4.x</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="落地页生成"><a href="#落地页生成" class="header-anchor">#</a> 落地页生成</h1> <div class="language- extra-class"><pre class="language-text"><code>如何使用 Vue + ElementUI + SSR 生成落地页
</code></pre></div><h2 id="什么是落地页"><a href="#什么是落地页" class="header-anchor">#</a> 什么是落地页</h2> <p>落地页，又称着陆页、引导页，在互联网营销中，引导页就是当潜在用户点击广告或者利用搜索引擎搜索后显示给用户的网页。一般这个页面会显示和所点击广告或搜索结果链接相关的扩展内容，而且这个页面应该是针对某个关键字（或短语）做过搜索引擎优化的。</p> <p>以游戏发行公司为例，在百度、今日头条、快手等平台上投放广告，用户点击广告进来的那个页面就是落地页，下面是几个典型落地页参考</p> <p><img src="https://img.zcool.cn/community/01fe9a5b9ca115a8012099c8a46ed7.gif" alt="传奇"></p> <p><img src="https://img.zcool.cn/community/0156775b9ca113a801213dea3f535f.gif" alt="红月传说"></p> <p><img src="https://img.zcool.cn/community/01a1845a213cf4a801216e8d3e8d87.jpg" alt="暗黑契约"></p> <p>落地页有下面几个特点</p> <ul><li>设计简洁明了、重点突出</li> <li>对搜索引擎友好</li> <li>可收集用户信息</li></ul> <p>落地页的意义都很明确，无外乎是下面五个</p> <ol><li>主站导量，让用户访问网站，并点击到网站的其他页面</li> <li>让用户购买 产品或服务</li> <li>让用户允许你跟进联系（通过电邮、电话或其他方式）</li> <li>让用户告诉其他人</li> <li>让用户了解某些内容，最好能得到用户的反馈，比如写一条评论或其他方式的反馈。</li></ol> <p>对于我们来说，我们主要是第二种，也就是<code>让用户下载安装并玩我们的游戏</code></p> <p><strong>毫不夸张的说，落地页是<code>信息流广告</code>转化的核心</strong></p> <p><em><a href="http://www.mysemlife.com/8783" target="_blank" rel="noopener noreferrer">优化师看过来，10 大行业优秀落地页案例大盘点！<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p> <h2 id="输入输出是什么"><a href="#输入输出是什么" class="header-anchor">#</a> 输入输出是什么</h2> <p>至于如何生成落地页，我们有很多种方案，最简单的方案就是找第三方平台制作，如<code>粒子广告</code>、<code>兔展网</code>，但这些方式有一个致命弱点就是数据不在我们这边，所以我们都是自己通过程序的方式生成落地页。</p> <p>在开始制作前我们需要准备落地页的素材，如图片、文案、目标应用下载地址等</p> <p>最终通过程序我们会生成一个 html 文件，这份文件会被上传到服务器上，得到一个查看链接，最终会由市场营销人员投放</p> <ul><li>输入：<code>素材</code>（图片、文案、应用）</li> <li>输出：<code>html</code> 文件</li></ul> <h2 id="生成的具体思路"><a href="#生成的具体思路" class="header-anchor">#</a> 生成的具体思路</h2> <p>在制作落地页时，我们需要可视化操作，通过在管理页面上拖拽和配置模块，页面会自动显示对应的内容，这部分可以由前端通过组件化的形式处理。</p> <p>配置完页面后，把模块的排列顺序和配置信息统一传给后台，后台通过某种途径，转化成 <code>html</code> 文件。</p> <p>转化途径有多种，如通过 <code>ejs 模板文件，渲染成 html</code>；或通过 <code>vue ssr 服务端渲染，生成 html</code> 文件</p> <p>从技术角度和维护成本出发，我们选用 <strong><code>vue ssr 服务端渲染</code></strong> 的形式,下面是具体思路：</p> <ol><li>开发常用的组件，如图片、按钮、表单等</li> <li>注册成全局组件</li> <li>通过拓展形式改变组件上下排版</li> <li>通过 prop 形式改变组件内部展示</li> <li>传递排列顺序和配置信息 prop 给服务端</li> <li>服务端与前端共用同一套渲染组件</li> <li>注入相关资源（css、js）</li> <li>注入 SEO</li> <li>生成 html 字符串</li> <li>写入文件</li> <li>上传服务器/CDN，得到查看地址</li></ol> <h2 id="技-术-栈"><a href="#技-术-栈" class="header-anchor">#</a> 技 术 栈</h2> <table><thead><tr><th style="text-align:center;">-</th> <th style="text-align:center;">作用</th> <th style="text-align:center;">官网</th></tr></thead> <tbody><tr><td style="text-align:center;">nodejs</td> <td style="text-align:center;">服务端，核心功能实现</td> <td style="text-align:center;"><a href="http://nodejs.cn/api" target="_blank" rel="noopener noreferrer">http://nodejs.cn/api<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td style="text-align:center;">koa</td> <td style="text-align:center;">提供 http 功能</td> <td style="text-align:center;"><a href="https://koa.bootcss.com" target="_blank" rel="noopener noreferrer">https://koa.bootcss.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td style="text-align:center;">vue</td> <td style="text-align:center;">MVVM 框架</td> <td style="text-align:center;"><a href="https://cn.vuejs.org" target="_blank" rel="noopener noreferrer">https://cn.vuejs.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td style="text-align:center;">element-ui</td> <td style="text-align:center;">UI 库</td> <td style="text-align:center;"><a href="https://element.eleme.cn/#/zh-CN" target="_blank" rel="noopener noreferrer">https://element.eleme.cn/#/zh-CN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td style="text-align:center;">webpack</td> <td style="text-align:center;">前端项目构建工具</td> <td style="text-align:center;"><a href="https://www.webpackjs.com" target="_blank" rel="noopener noreferrer">https://www.webpackjs.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td style="text-align:center;">vue-server-renderer</td> <td style="text-align:center;">服务端渲染</td> <td style="text-align:center;"><a href="https://ssr.vuejs.org/zh" target="_blank" rel="noopener noreferrer">https://ssr.vuejs.org/zh<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr></tbody></table> <h2 id="项目结构"><a href="#项目结构" class="header-anchor">#</a> 项目结构</h2> <div class="language- extra-class"><pre class="language-text"><code>┌── build
│   ├── base.config.js # webpack配置基础
│   ├── dev.config.js # 开发环境配置
│   ├── dll.config.js # 打包dll配置
│   ├── prod.config.js # 生产环境配置
│   └── server.config.js # 服务端渲染配置
├── controller
│   └── TemplateCtrl.js # 落地页生成底层
├── src
│   ├── assets
│   │   └── images
│   │       └── iphone6.png # 手机外观图
│   ├── components
│   │   └── Template.vue # 落地页配置页面
│   ├── plugins
│   │   ├── Button.vue # 按钮组件
│   │   └── Image.vue # 图片组件
│   ├── api.config.js # api封装
│   ├── axios.config.js # http拦截器
│   ├── enter-server.js # 服务端渲染入口
│   └── main.js # 客户端渲染入口
├── app.js # koa 入口文件
├── index.html # 客户端页面模板
├── index.template.html # 服务端渲染模板
└── package.json # nodejs 项目配置
</code></pre></div><h2 id="依赖模块"><a href="#依赖模块" class="header-anchor">#</a> 依赖模块</h2> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;animate.css&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.7.2&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;axios&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.19.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;ejs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.7.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;element-ui&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.11.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;highlight.js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^9.15.10&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;html-minifier&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.0.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;js-md5&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.7.3&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;jsonwebtoken&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.5.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;koa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.8.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;koa-bodyparser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.2.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;koa-router&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^7.4.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;koa-session&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.12.2&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;koa-static&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.0.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;lowdb&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;marked&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.7.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;mockjs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.1-beta3&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;moment&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.24.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;nodejs-websocket&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.7.2&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;nodemon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.19.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;qr-image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.2.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;svg-captcha&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.4.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;vue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.6.10&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;vue-router&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.1.2&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;vue-server-renderer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.6.10&quot;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;babel-core&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.26.3&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;babel-eslint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^10.0.3&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;babel-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.0.6&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;babel-plugin-transform-runtime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.23.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;babel-preset-es2015&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.24.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;babel-preset-stage-2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.24.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;babel-runtime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.26.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;clean-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;cross-env&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.2.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;css-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.2.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;eslint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.4.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;eslint-config-airbnb-base&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^14.0.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;eslint-friendly-formatter&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.0.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;eslint-import-resolver-webpack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.11.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;eslint-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;eslint-plugin-html&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.0.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;eslint-plugin-import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.18.2&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;eslint-plugin-vue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.2.3&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;file-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.2.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;html-webpack-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.2.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;less&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.10.3&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;less-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.0.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;mini-css-extract-plugin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.8.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;open&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.4.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;portfinder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.24&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;style-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;url-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.1.0&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;vue-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^15.7.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;vue-style-loader&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.1.2&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;vue-template-compiler&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.6.10&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;webpack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.40.2&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;webpack-cli&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.3.8&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;webpack-dev-server&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.8.1&quot;</span><span class="token punctuation">,</span>
		<span class="token property">&quot;webpack-merge&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.2.2&quot;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="vue-项目搭建"><a href="#vue-项目搭建" class="header-anchor">#</a> vue 项目搭建</h2> <h3 id="插件规范"><a href="#插件规范" class="header-anchor">#</a> 插件规范</h3> <p>我们在 <code>src/plugins</code> 中写了各种组件，这些组件可以被拖拽到页面上进行落地页配置，plugins 下的每一个组件都是一个独立可用的插件，它需要具备下面几个属性</p> <table><thead><tr><th style="text-align:center;">属性</th> <th style="text-align:center;">描述</th> <th style="text-align:center;">作用</th></tr></thead> <tbody><tr><td style="text-align:center;">name</td> <td style="text-align:center;">标签名称</td> <td style="text-align:center;">vue 注册全局组件的名称</td></tr> <tr><td style="text-align:center;">title</td> <td style="text-align:center;">组件名称</td> <td style="text-align:center;">组件列表显示的名称</td></tr> <tr><td style="text-align:center;">sort</td> <td style="text-align:center;">排序权重</td> <td style="text-align:center;">列表中的排列位置</td></tr> <tr><td style="text-align:center;">icon</td> <td style="text-align:center;">组件图标</td> <td style="text-align:center;">列表的显示图标</td></tr> <tr><td style="text-align:center;">props</td> <td style="text-align:center;">配置参数</td> <td style="text-align:center;">可配置参数，内部会根据此参数动态显示</td></tr></tbody></table> <p>下面是一个简单的演示</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- src/plugins/Button.vue --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>plugin-button<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      {{message}}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span>
export default {
  name: 'plugin-button',
  title: '按钮',
  icon: 'el-icon-thumb',
  props: {
    message: {
      type: String,
      default: '提交',
      label: '描述',
      placeholder: '请输入按钮的描述',
      layout: 'el-input'
    }
  }
}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>less<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span>
.plugin-button {
  .content {
    width: 100%;
    background: #1c80e6;
    color: #fff;
    text-align: center;
    line-height: 40px;
    border-radius: 6px;
  }
}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>只要是按照上述要求开发的插件，我们会通过<code>require.context</code>的方式引入并注册到全局组件下</p> <p><em>注：<code>props</code>是 vue 单文件组件的 props 属性,但多加了几个选项，分别是<code>label、placeholder和layout</code>，它们分别代表配置表单时的名称、占位符和表单类型</em></p> <h3 id="入口实例化"><a href="#入口实例化" class="header-anchor">#</a> 入口实例化</h3> <p>前面我们规定了插件是如何开发的，下面我们把这些插件注册成全局组件并实例化 vue</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/main.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> animated <span class="token keyword">from</span> <span class="token string">'animate.css'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ElementUI <span class="token keyword">from</span> <span class="token string">'element-ui'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'./axios.config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./api.config'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Template <span class="token keyword">from</span> <span class="token string">'./components/Template.vue'</span><span class="token punctuation">;</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>animated<span class="token punctuation">)</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ElementUI<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 插件配置</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pluginFiles <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">'./plugins'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token regex">/.vue$/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pluginFiles<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">pluginFiles</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 注册全局组件</span>
		Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>name<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token punctuation">{</span>
			key<span class="token punctuation">,</span>
			name<span class="token operator">:</span> component<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
			sort<span class="token operator">:</span> component<span class="token punctuation">.</span>sort <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
			animate<span class="token operator">:</span> component<span class="token punctuation">.</span>animate <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
			title<span class="token operator">:</span> component<span class="token punctuation">.</span>title <span class="token operator">||</span> component<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
			icon<span class="token operator">:</span> component<span class="token punctuation">.</span>icon <span class="token operator">||</span> <span class="token string">'el-icon-loading'</span><span class="token punctuation">,</span>
			configs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 可通过数据劫持自动生成props</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token comment">// 构建插件配置</span>
		Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">prop</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			item<span class="token punctuation">.</span>configs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				key<span class="token operator">:</span> prop<span class="token punctuation">,</span>
				label<span class="token operator">:</span> component<span class="token punctuation">.</span>props<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">.</span>label<span class="token punctuation">,</span>
				value<span class="token operator">:</span> component<span class="token punctuation">.</span>props<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">.</span>default<span class="token punctuation">,</span>
				type<span class="token operator">:</span> component<span class="token punctuation">.</span>props<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
				placeholder<span class="token operator">:</span> component<span class="token punctuation">.</span>props<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">.</span>placeholder <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
plugins<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>sort <span class="token operator">-</span> b<span class="token punctuation">.</span>sort<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$plugins <span class="token operator">=</span> plugins<span class="token punctuation">;</span> <span class="token comment">// 直接挂载到vue原型上</span>

<span class="token comment">// 实例化</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
	<span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>Template<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="落地页配置"><a href="#落地页配置" class="header-anchor">#</a> 落地页配置</h3> <p>我们在<code>src/components/template.vue</code>中实现落地页具体配置，下面是 UI 效果</p> <p><img src="http://zhkumsg.gitee.io/imagepub/20190923172020.png" alt="UI效果"></p> <p><img src="http://zhkumsg.gitee.io/imagepub/20190923172600.png" alt="动画"></p> <p>在 <code>src/componets/Template.vue</code> 页面中,我们通过实例化时挂载的 <code>$plugins</code> 渲染出左侧插件栏，点击或拖拽插件栏内容时，自动在中间手机界面上添加一个元素（数据驱动）,然后点击手机界面上新添加的这个组件，会在右侧弹出配置栏，这个配置栏就是我们前面提到的 <code>props</code> 属性，只要配置栏发生了改变，手机界面就会动态发生改变。</p> <p>下面是比较特殊的一段代码，它的作用是利用数据拦截（vue 底层也是它）构建手机界面配置数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/components/Template.vue 左侧插件栏点击时触发</span>
<span class="token function">handlePluginClick</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 深拷贝插件信息</span>
  <span class="token comment">// 构建数据劫持，单向绑定props</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'props'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      item<span class="token punctuation">.</span>configs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        obj<span class="token punctuation">[</span>o<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> o<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 数据驱动，手机界面添加多了一个组件</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>componentList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自动滚动最下面</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>viewscroll<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>viewscroll<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="落地页信息提交"><a href="#落地页信息提交" class="header-anchor">#</a> 落地页信息提交</h3> <p>我们只需要提供落地页的配置就可以生成一个 html 页面了，需要提供的信息有</p> <div class="language- extra-class"><pre class="language-text"><code>用了哪个插件、这个插件的 props 是什么
</code></pre></div><p>后面的工作就交给服务端处理了</p> <h2 id="koa-项目搭建"><a href="#koa-项目搭建" class="header-anchor">#</a> koa 项目搭建</h2> <p>有了页面自然就需要接口，我们使用 <code>koa</code> 提供 <code>api 服务</code>，下面是主文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> koaStatic <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 落地页渲染核心</span>
<span class="token keyword">const</span> TemplateCtrl <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./controller/TemplateCtrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// TODO 静态资源</span>

<span class="token comment">// 路由配置</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/template/preview'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TemplateCtrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preview</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TemplateCtrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 预览</span>

<span class="token comment">// 开启服务</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在这里我们启动了一个 <code>koa</code> 服务，它监听 <code>3000</code> 端口，有一个<code>/api/template/preview</code> 路由，核心文件 <code>TemplateCtrl</code> 内部有一个 <code>preview</code> 方法 <em>(这里可以先不管 preview 是如何实现的，注释即可，下面会介绍)</em>。</p> <h3 id="服务端渲染的原理"><a href="#服务端渲染的原理" class="header-anchor">#</a> 服务端渲染的原理</h3> <p>落地页生成的核心在于服务端渲染。Vue.js 是构建客户端应用程序的框架。默认情况下，可以在浏览器中输出 Vue 组件，进行生成 DOM 和操作 DOM。然而，也可以将同一个组件渲染为服务器端的 HTML 字符串，将它们直接发送到浏览器，最后将这些静态标记&quot;激活&quot;为客户端上完全可交互的应用程序</p> <p>服务器渲染的 Vue.js 应用程序也可以被认为是&quot;同构&quot;或&quot;通用&quot;，因为应用程序的大部分代码都可以在服务器和客户端上运行</p> <p>与传统 SPA (单页应用程序 (Single-Page Application)) 相比，服务器端渲染 (SSR) 的优势主要在于：</p> <ul><li><p>更好的 SEO，由于搜索引擎爬虫抓取工具可以直接查看完全渲染的页面。</p></li> <li><p>更快的内容到达时间 (time-to-content)，特别是对于缓慢的网络情况或运行缓慢的设备。无需等待所有的 JavaScript 都完成下载并执行，才显示服务器渲染的标记，所以你的用户将会更快速地看到完整渲染的页面。通常可以产生更好的用户体验，并且对于那些「内容到达时间(time-to-content) 与转化率直接相关」的应用程序而言，服务器端渲染 (SSR) 至关重要。</p></li></ul> <p><a href="https://ssr.vuejs.org/zh/guide/" target="_blank" rel="noopener noreferrer">vue ssr 官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>向我们展示了一个很好的项目，但它过于完善，到时入门难度大，往往我们实现到<code>基本用法</code>，后面的就不知道在说什么了，下面我将以简单的形式进行说明</p> <ol><li><p>首先我们先创建一个 html 模板文件，它作为服务端渲染的基础内容</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- index.template.html --&gt;</span>
<span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>zh-CH<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    {{{ meta }}}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span>
      * {
        margin: 0;
        padding: 0;
      }
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--vue-ssr-outlet--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>然后我们构建服务端渲染的入口文件（和客户端渲染入口基本一样，去除了没必要的内容）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/enter-server.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> animated <span class="token keyword">from</span> <span class="token string">'animate.css'</span><span class="token punctuation">;</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>animated<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">DEFAULT_PLUGINS_PATH</span> <span class="token operator">=</span> <span class="token string">'./plugins'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 【注入点1】 默认插件位置，程序调用时会自动替换成../../src/plugins</span>
<span class="token keyword">const</span> pluginFiles <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">DEFAULT_PLUGINS_PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token regex">/.vue$/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pluginFiles<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">pluginFiles</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>component<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> /&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>name<span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 默认内容</span>
<span class="token keyword">const</span> <span class="token constant">DEFAULT_INJECTION_CONTENT</span> <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token comment">// 【注入点2】 程序会自动注入信息到下面的${...}中</span>
			template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">DEFAULT_INJECTION_CONTENT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">resolve</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>以 <code>enter-server.js</code> 为入口文件，使用 <code>webpack 打包成 bundle 文件</code></p></li> <li><p><strong>读取刚刚打包的 bundle 文件内容，使用 SSR 的 <code>createBundleRenderer</code> 方法解析 bundle 文件成 <code>html</code> 字符串</strong></p></li> <li><p>压缩 html，写入到新文件中，完成 html 的生成</p></li></ol> <p>服务端渲染的关键方法是<code>createBundleRenderer</code>，官方文档如</p> <p><code>vue-server-renderer</code> 提供一个名为 <code>createBundleRenderer</code> 的 API，用于处理此问题，通过使用 webpack 的自定义插件，server bundle 将生成为可传递到 bundle renderer 的特殊 JSON 文件。所创建的 bundle renderer，用法和普通 renderer 相同，但是 bundle renderer 提供以下优点：</p> <ol><li>内置的 source map 支持（在 webpack 配置中使用 devtool: 'source-map'）</li> <li>在开发环境甚至部署过程中热重载（通过读取更新后的 bundle，然后重新创建 renderer 实例）</li> <li>关键 CSS(critical CSS) 注入（在使用 *.vue 文件时）：自动内联在渲染过程中用到的组件所需的 CSS。更多细节请查看 CSS 章节。</li> <li>使用 clientManifest 进行资源注入：自动推断出最佳的预加载(preload)和预取(prefetch)指令，以及初始渲染所需的代码分割 chunk。</li></ol> <h3 id="webpack-配置"><a href="#webpack-配置" class="header-anchor">#</a> webpack 配置</h3> <p>要使用 ssr 功能，我们使用 webpack 打包成 bundle 文件，下面是具体的 webpack 配置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./base.config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
	baseConfig<span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
		target<span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
		entry<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/enter-server.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		output<span class="token operator">:</span> <span class="token punctuation">{</span>
			path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../preview'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			filename<span class="token operator">:</span> <span class="token string">'server-bundle.js'</span><span class="token punctuation">,</span>
			libraryTarget<span class="token operator">:</span> <span class="token string">'commonjs2'</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
			<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				<span class="token string">'process.env.VUE_ENV'</span><span class="token operator">:</span> <span class="token string">'&quot;server&quot;'</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>内容很简单，处理基本配置（各种 loader 配置）外，主要就配置了目标环境是 <code>node</code> ，实例化入口文件是 <code>enter-server.js</code> ,以及出口文件是 <code>server-bundle.js</code> 。</p> <h3 id="使用-webpack-打包"><a href="#使用-webpack-打包" class="header-anchor">#</a> 使用 webpack 打包</h3> <p>因为每一次请求都需要打包出一个新的 <code>bundle</code> 文件，所以我们需要通过程序化的形式打包，每一次打包的参数都不一样，比如 vue 实例的模板 <code>template</code> 不一样，使用的<code>组件</code>不一样，使用的<code>配置</code>不一样</p> <p>所以我们需要通过 IO 操作的形式，动态拷贝一份 <code>enter-server.js</code> 入口文件，并修改里面的信息，如</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 【注入点2】 程序会自动注入信息到下面的${...}中</span>
template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">DEFAULT_INJECTION_CONTENT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
</code></pre></div><p>除此之外，webpack 配置文件也需要动态修改，因为入口文件的路径和出口文件的路径都相应的变化了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../build/server.config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 配置新的webpack配置</span>
serverConfig<span class="token punctuation">.</span>entry <span class="token operator">=</span> enterPath<span class="token punctuation">;</span> <span class="token comment">// 修改入口</span>
serverConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path <span class="token operator">=</span> outputPath<span class="token punctuation">;</span> <span class="token comment">// 修改出口</span>

<span class="token comment">// 开始打包bundle</span>
<span class="token function">webpack</span><span class="token punctuation">(</span>serverConfig<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// TODO</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最后会在特定位置打包出一个新的 bundle 文件</p> <h3 id="使用-ssr-解析-bundle-文件"><a href="#使用-ssr-解析-bundle-文件" class="header-anchor">#</a> 使用 SSR 解析 bundle 文件</h3> <p><code>vue-server-renderer</code> 其实这里才开始用上,关键操作如下</p> <p>读取 bundle 文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bundlePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serverConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serverConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token comment">// 获取bundle内容</span>
<span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readBundle</span><span class="token punctuation">(</span>bundlePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>解析 bundle 文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bundleRenderer <span class="token operator">=</span> vueSSRRender<span class="token punctuation">.</span><span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	template<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../index.template.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>生成 html 字符串</p> <div class="language-js extra-class"><pre class="language-js"><code>bundleRenderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token punctuation">,</span> meta <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// TODO</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// TemplateCtrl.js</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> qr <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'qr-image'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> minify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-minifier'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>minify<span class="token punctuation">;</span>
<span class="token keyword">const</span> vueSSRRender <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ssr 渲染</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> domain<span class="token punctuation">,</span> webPort <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">TemplateCtrl</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
	 * 预览
	 * @param {*} ctx
	 */</span>
	<span class="token keyword">async</span> <span class="token function">preview</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token punctuation">{</span> components<span class="token punctuation">,</span> title<span class="token punctuation">,</span> metas <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
		<span class="token keyword">const</span> contents <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>components<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拼接成html</span>
		<span class="token comment">// 插入预览提示语</span>
		contents<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>
			<span class="token string">'&lt;div style=&quot;background:#ff6c6c;padding:10px;color:#fff;font-size:12px;text-align:center;&quot;&gt;当前处于预览模式,请勿直接用于投放&lt;/div&gt;'</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			ctx<span class="token punctuation">.</span>responseModel<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ssrRenderer</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> title<span class="token punctuation">,</span> metas<span class="token punctuation">,</span> <span class="token string">'preview'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 渲染并返回预览信息</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			ctx<span class="token punctuation">.</span>responseModel<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			ctx<span class="token punctuation">.</span>responseModel<span class="token punctuation">.</span>msg <span class="token operator">=</span> error<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>responseModel<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 配置转组件
	 * @param {*} components
	 */</span>
	<span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">components</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>components <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> attrs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>o<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>o<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>attrs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> class='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>o<span class="token punctuation">.</span>animate<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' /&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * ssr 渲染
	 * @param {*} content vue插件内容
	 * @param {*} title 文档标题
	 * @param {*} metas meta
	 * @param {*} mode 模式 preview/publish
	 * @param {*} id 如果publish，这里会是文件夹
	 */</span>
	<span class="token function">ssrRenderer</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> title <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> metas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode <span class="token operator">=</span> <span class="token string">'preview'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token punctuation">{</span> enterPath<span class="token punctuation">,</span> outputPath<span class="token punctuation">,</span> folder <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">copySSREnter</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 复制新的的入口</span>
			<span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../build/server.config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 配置新的webpack配置</span>
			serverConfig<span class="token punctuation">.</span>entry <span class="token operator">=</span> enterPath<span class="token punctuation">;</span>
			serverConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path <span class="token operator">=</span> outputPath<span class="token punctuation">;</span>
			<span class="token function">webpack</span><span class="token punctuation">(</span>serverConfig<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token keyword">const</span> bundlePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serverConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>serverConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
					<span class="token comment">// 获取bundle内容</span>
					<span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readBundle</span><span class="token punctuation">(</span>bundlePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">// 转变成HTML</span>
					<span class="token keyword">const</span> bundleRenderer <span class="token operator">=</span> vueSSRRender<span class="token punctuation">.</span><span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>bundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
						template<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../index.template.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">const</span> meta <span class="token operator">=</span> metas<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">o</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;meta name='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>o<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' content='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>o<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' /&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">// 生成vue实例</span>
					bundleRenderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token punctuation">,</span> meta <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
							fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>
								<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>outputPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
								<span class="token function">minify</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token punctuation">{</span>
									removeComments<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
									collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
									minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
								<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
								<span class="token string">'utf8'</span>
							<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成html文档[已被压缩]</span>
							<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>domain<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webPort<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
							<span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data:image/png;base64,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qr<span class="token punctuation">.</span><span class="token function">imageSync</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> margin<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
							<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">,</span> img <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 复制入口文件
	 * @param {*} content
	 * @param {*} mode preview / publish
	 * @param {*} folder
	 */</span>
	<span class="token function">copySSREnter</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> mode <span class="token operator">=</span> <span class="token string">'preview'</span><span class="token punctuation">,</span> folder <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		folder <span class="token operator">=</span> folder <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 以毫秒作为文件夹名(发布时在原文件夹内操作)</span>
		<span class="token keyword">const</span> enter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readBundle</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/enter-server.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取源文件</span>
		<span class="token keyword">const</span> outputPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出所在文件夹</span>
		<span class="token keyword">const</span> enterPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/enter-server.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 入口文件</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initFolderSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initFolderSync</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成新目录</span>
		<span class="token keyword">const</span> jsContent <span class="token operator">=</span> enter
			<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\$\{DEFAULT_PLUGINS_PATH\}/g</span><span class="token punctuation">,</span> <span class="token string">'../../src/plugins'</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\$\{DEFAULT_INJECTION_CONTENT\}/g</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注入变化信息</span>
		fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>enterPath<span class="token punctuation">,</span> jsContent<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 复制入口文件</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span>
			mode<span class="token punctuation">,</span>
			folder<span class="token punctuation">,</span>
			enterPath<span class="token punctuation">,</span>
			outputPath<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 读取bundle文件
	 * @param {*} filePath
	 */</span>
	<span class="token function">readBundle</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 初始化文件夹，不存在就新建
	 * @param {*} folderPath
	 */</span>
	<span class="token function">initFolderSync</span><span class="token punctuation">(</span><span class="token parameter">folderPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">,</span> fs<span class="token punctuation">.</span><span class="token constant">F_OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>folderPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><em>调用接口后，会返回预览地址，点击预览地址即可查看(生成的 html 放到静态资源文件夹下)</em></p> <h2 id="更-多"><a href="#更-多" class="header-anchor">#</a> 更 多</h2> <p>当然还可以接入更多的功能，如上传到 CDN、使用数据库保存数据、加入埋点处理、加入退弹页功能等，这些都有实现，但篇幅有限，更多可看源码</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/6/2020, 3:11:47 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sso/how-to-use-pm2web.html" class="prev">PM2 性能监控</a></span> <span class="next"><a href="/sso/what-about-on-webpack-update.html">webpack 2.x 升级到 4.x</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3328e81d.js" defer></script><script src="/assets/js/2.c715c0f2.js" defer></script><script src="/assets/js/61.70db4cce.js" defer></script>
  </body>
</html>
