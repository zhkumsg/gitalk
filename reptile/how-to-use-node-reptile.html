<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nodejs 网络爬虫 | Wiki文档中心</title>
    <meta name="description" content="描述">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.4d8ba4a7.css" as="style"><link rel="preload" href="/assets/js/app.3328e81d.js" as="script"><link rel="preload" href="/assets/js/2.c715c0f2.js" as="script"><link rel="preload" href="/assets/js/55.5fb2a242.js" as="script"><link rel="prefetch" href="/assets/js/10.abfcde09.js"><link rel="prefetch" href="/assets/js/11.3ee26f26.js"><link rel="prefetch" href="/assets/js/12.45406b92.js"><link rel="prefetch" href="/assets/js/13.7aa97305.js"><link rel="prefetch" href="/assets/js/14.34708031.js"><link rel="prefetch" href="/assets/js/15.76570f77.js"><link rel="prefetch" href="/assets/js/16.29d4e7cd.js"><link rel="prefetch" href="/assets/js/17.eda984dd.js"><link rel="prefetch" href="/assets/js/18.1bb9f9b9.js"><link rel="prefetch" href="/assets/js/19.231ae034.js"><link rel="prefetch" href="/assets/js/20.26a455ac.js"><link rel="prefetch" href="/assets/js/21.62f18186.js"><link rel="prefetch" href="/assets/js/22.177e8b0f.js"><link rel="prefetch" href="/assets/js/23.60274af5.js"><link rel="prefetch" href="/assets/js/24.0ea00a49.js"><link rel="prefetch" href="/assets/js/25.3d5be951.js"><link rel="prefetch" href="/assets/js/26.19229e66.js"><link rel="prefetch" href="/assets/js/27.6d99c0ab.js"><link rel="prefetch" href="/assets/js/28.d28de4e0.js"><link rel="prefetch" href="/assets/js/29.29379faf.js"><link rel="prefetch" href="/assets/js/3.90a63800.js"><link rel="prefetch" href="/assets/js/30.9fe6691b.js"><link rel="prefetch" href="/assets/js/31.2c753b40.js"><link rel="prefetch" href="/assets/js/32.b87ed25b.js"><link rel="prefetch" href="/assets/js/33.69099052.js"><link rel="prefetch" href="/assets/js/34.fb2e76ab.js"><link rel="prefetch" href="/assets/js/35.41f3d46b.js"><link rel="prefetch" href="/assets/js/36.78adf827.js"><link rel="prefetch" href="/assets/js/37.6cb8f1dc.js"><link rel="prefetch" href="/assets/js/38.3296535c.js"><link rel="prefetch" href="/assets/js/39.852ec6ec.js"><link rel="prefetch" href="/assets/js/4.338175e6.js"><link rel="prefetch" href="/assets/js/40.4f030cd4.js"><link rel="prefetch" href="/assets/js/41.7b948635.js"><link rel="prefetch" href="/assets/js/42.7038bdd7.js"><link rel="prefetch" href="/assets/js/43.09ba85b3.js"><link rel="prefetch" href="/assets/js/44.30c43542.js"><link rel="prefetch" href="/assets/js/45.7fc52c71.js"><link rel="prefetch" href="/assets/js/46.e57513f1.js"><link rel="prefetch" href="/assets/js/47.79ad04e1.js"><link rel="prefetch" href="/assets/js/48.806e5af9.js"><link rel="prefetch" href="/assets/js/49.1e083288.js"><link rel="prefetch" href="/assets/js/5.15ce4230.js"><link rel="prefetch" href="/assets/js/50.eef1990e.js"><link rel="prefetch" href="/assets/js/51.cdde33a8.js"><link rel="prefetch" href="/assets/js/52.bcb09293.js"><link rel="prefetch" href="/assets/js/53.87c2baec.js"><link rel="prefetch" href="/assets/js/54.4d9707e7.js"><link rel="prefetch" href="/assets/js/56.63b1cb46.js"><link rel="prefetch" href="/assets/js/57.4108fa62.js"><link rel="prefetch" href="/assets/js/58.38c656c4.js"><link rel="prefetch" href="/assets/js/59.2e9da043.js"><link rel="prefetch" href="/assets/js/6.4db8bcb4.js"><link rel="prefetch" href="/assets/js/60.62a9603a.js"><link rel="prefetch" href="/assets/js/61.70db4cce.js"><link rel="prefetch" href="/assets/js/62.c0b27237.js"><link rel="prefetch" href="/assets/js/63.a1ff59d9.js"><link rel="prefetch" href="/assets/js/64.ba32929f.js"><link rel="prefetch" href="/assets/js/65.504fa9a6.js"><link rel="prefetch" href="/assets/js/66.39a7e2d4.js"><link rel="prefetch" href="/assets/js/67.409ffc00.js"><link rel="prefetch" href="/assets/js/68.21b084fc.js"><link rel="prefetch" href="/assets/js/69.1d10efe9.js"><link rel="prefetch" href="/assets/js/7.6832275b.js"><link rel="prefetch" href="/assets/js/70.0391f331.js"><link rel="prefetch" href="/assets/js/71.af289666.js"><link rel="prefetch" href="/assets/js/72.9a8504b0.js"><link rel="prefetch" href="/assets/js/73.0d35f166.js"><link rel="prefetch" href="/assets/js/74.75cd3652.js"><link rel="prefetch" href="/assets/js/75.53679119.js"><link rel="prefetch" href="/assets/js/76.5ea9dd36.js"><link rel="prefetch" href="/assets/js/77.95fe4c15.js"><link rel="prefetch" href="/assets/js/78.aaff367b.js"><link rel="prefetch" href="/assets/js/8.3662cfcf.js"><link rel="prefetch" href="/assets/js/9.a40092b3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4d8ba4a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Wiki文档中心" class="logo"> <span class="site-name can-hide">Wiki文档中心</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/introduce/" class="nav-link">指南</a></div><div class="nav-item"><a href="/sso/" class="nav-link">单点登录</a></div><div class="nav-item"><a href="/seo/" class="nav-link">服务端渲染</a></div><div class="nav-item"><a href="/linux/" class="nav-link">Linux基础</a></div><div class="nav-item"><a href="/http/" class="nav-link">解读Http</a></div><div class="nav-item"><a href="/microfrontend/" class="nav-link">微前端</a></div><div class="nav-item"><a href="/weixin/" class="nav-link">微信全家桶</a></div><div class="nav-item"><a href="/performance/" class="nav-link">性能优化</a></div><div class="nav-item"><a href="/log/" class="nav-link">每日随笔</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/introduce/" class="nav-link">指南</a></div><div class="nav-item"><a href="/sso/" class="nav-link">单点登录</a></div><div class="nav-item"><a href="/seo/" class="nav-link">服务端渲染</a></div><div class="nav-item"><a href="/linux/" class="nav-link">Linux基础</a></div><div class="nav-item"><a href="/http/" class="nav-link">解读Http</a></div><div class="nav-item"><a href="/microfrontend/" class="nav-link">微前端</a></div><div class="nav-item"><a href="/weixin/" class="nav-link">微信全家桶</a></div><div class="nav-item"><a href="/performance/" class="nav-link">性能优化</a></div><div class="nav-item"><a href="/log/" class="nav-link">每日随笔</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nodejs-网络爬虫"><a href="#nodejs-网络爬虫" class="header-anchor">#</a> Nodejs 网络爬虫</h1> <p>使用 nodejs 爬取某汽车论坛信息</p> <h2 id="前-言"><a href="#前-言" class="header-anchor">#</a> 前 言</h2> <p>网络爬虫，是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本，通俗的讲就是通过程序去获取 web 页面上自己想要的数据。</p> <p>有了解的同学可能知道，世界上很大一部分的爬虫程序都是利用 <code>python</code> 进行开发的，但在这里，我将分享另一种途径的实现方式</p> <p><strong>使用 <code>Nodejs</code> 实现网络爬虫</strong></p> <p><em>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境，它可以运行在不同的环境上</em></p> <h2 id="背-景"><a href="#背-景" class="header-anchor">#</a> 背 景</h2> <p>某公司的市场营销人员需要从某汽车论坛网站上获取特定帖子的内容，如帖子标题、帖子内容、帖子图片数、帖子点击量和帖子评论数，他们有一份整理好的 <code>Excel</code> 表，需要依次填写相关的内容。因为 Excel 较大，需要打开很多的帖子去计算信息，工作强度大且无比枯燥，所以计划使用技术的方式去完成这一工作。</p> <p><img src="http://zhkumsg.gitee.io/imagepub/20190924140602.png" alt="汽车论坛"></p> <p><em>出于保护目标站点以及避免目标站点服务器遭受过多请求的考虑，本文不便透露具体网址</em></p> <h2 id="分-析"><a href="#分-析" class="header-anchor">#</a> 分 析</h2> <p>营销人员提供 Excel 数据源，通过程序解析 Excel 内容，获取到目标帖子网址，程序发起 Http 请求，爬取到帖子标题、帖子内容、帖子图片数、帖子点击量和帖子评论数等信息，最后把这些信息更新回 Excel 中</p> <ul><li><p>输入：<code>带 URL 的 Excel</code> (https://xxx.xxx/bbs/thread/32ad96e6395861f2/82365525-1.html)</p></li> <li><p>输出：<code>带帖子标题、帖子内容、帖子图片数、帖子点击量和帖子评论数的 Excel</code></p></li></ul> <p>通过分析网络请求 <code>NetWork</code> 发现，发起一个帖子 url 的 get 请求，响应内容为 html，里面包含着帖子的大部分信息,可以得知该论坛的帖子内容是服务端直接返回的，不是前端动态生成的。</p> <p><img src="http://zhkumsg.gitee.io/imagepub/20190924143724.png" alt="帖子内容"></p> <p>通过在新标签页打开链接发现内容正常可见，这说明不需要登录就可以查看</p> <p>接着去看响应发现点击和评论为<code>0</code>，下面是响应片段</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>consnav<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>consnav<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>fr fon12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>点击：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>x-views<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">&gt;</span></span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span>|<span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span>回复：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>x-replys<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>那么很明显,这两个信息是会被 js 以 dom 操作的形式修改，认真审查 Network，发现，有一个比较奇怪的请求</p> <div class="language- extra-class"><pre class="language-text"><code>https://xxx.xxx.com.cn/Detail/LoadX_Mini?callback=jsonpCallback&amp;topicId=82365525&amp;UID=-1&amp;roleId=-1&amp;bbs=c&amp;bbsid=3362&amp;pageIndex=1&amp;isOwner=false&amp;memberIds=82797775%2C4902887%2C8875877%2C11044096%2C7903777%2C70299610%2C80361417%2C28978585%2C5293222%2C999595&amp;recom=9&amp;_=1569310928990
</code></pre></div><p>是一个 jsonp 的请求,该请求里的响应包含着点击数和回复数，响应片段如下</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;isUpTopic&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	<span class="token property">&quot;topicClicks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;TopicId&quot;</span><span class="token operator">:</span> <span class="token number">82365525</span><span class="token punctuation">,</span> <span class="token property">&quot;Replys&quot;</span><span class="token operator">:</span> <span class="token number">183</span><span class="token punctuation">,</span> <span class="token property">&quot;Views&quot;</span><span class="token operator">:</span> <span class="token number">106814</span><span class="token punctuation">,</span> <span class="token property">&quot;memberid&quot;</span><span class="token operator">:</span> <span class="token number">82797775</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;favoriteNum&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token property">&quot;floorAD&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;articleTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
			<span class="token property">&quot;adurl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;articleTitle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
			<span class="token property">&quot;adurl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;uniquePageId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;GuSpHzTegYFJ7Y9Us92mZVuOy9DAQIMy+IezoJqnE28=&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;ptci&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;gzgg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;onTopReply&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token property">&quot;masterClubType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;recom&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;replyState&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;noSpeakStatus&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;ClubUserNoSpeak&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;masterOpBbs&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们关心的信息是 <code>&quot;Replys&quot;: 183, &quot;Views&quot;: 106814</code></p> <p>分析此 jsonp 请求，我们发现可以使用下面的 url 代替，结果是一样的</p> <div class="language- extra-class"><pre class="language-text"><code>https://xxx.xxx.com.cn/Detail/LoadX_Mini?topicId=82365525
</code></pre></div><p>这里面需要一个 <code>topicId</code> 查询字符串，从技术角度出发，我们猜它是前面帖子的 id，果然在 https://xxx.xxx/bbs/thread/32ad96e6395861f2/<code>82365525</code>-1.html 上找到了我们要的信息</p> <h2 id="技术栈"><a href="#技术栈" class="header-anchor">#</a> 技术栈</h2> <table><thead><tr><th style="text-align:center;">技术</th> <th style="text-align:center;">备注</th></tr></thead> <tbody><tr><td style="text-align:center;">nodejs</td> <td style="text-align:center;">爬虫底层实现</td></tr> <tr><td style="text-align:center;">cheerio</td> <td style="text-align:center;">html 解析</td></tr> <tr><td style="text-align:center;">xlsx</td> <td style="text-align:center;">xlsx 解析</td></tr> <tr><td style="text-align:center;">bootstrap</td> <td style="text-align:center;">内容展示</td></tr></tbody></table> <h2 id="流-程"><a href="#流-程" class="header-anchor">#</a> 流 程</h2> <ol><li><p>监听 <code>8080</code> 端口，启动 <code>http</code> 服务</p></li> <li><p>开放 <code>/api/upload</code> 路由，接收用户上传 <code>excel</code></p></li> <li><p>接收用户上传文件，解析 <code>excel</code></p></li> <li><p>构建目标帖子<code>数据源</code></p></li> <li><p>循环发起 <code>http get</code> 请求（第一个）</p></li> <li><p>解析响应，取出<em>标题和帖子内容以及图片个数</em></p></li> <li><p>截取 url 中的<code>帖子 id</code>，发起 <code>http post</code> 请求（第二个）</p></li> <li><p>解析响应，取到<em>点击量和评论数</em></p></li> <li><p><code>合并</code>两个请求数据，构建数据，录入<code>数据库</code></p></li> <li><p><code>睡眠 0.5 秒</code>，发起下一个请求</p></li> <li><p>全部帖子爬取完成，退出任务</p></li></ol> <h2 id="实-现"><a href="#实-现" class="header-anchor">#</a> 实 现</h2> <h3 id="启动-http-服务"><a href="#启动-http-服务" class="header-anchor">#</a> 启动 http 服务</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// TODO 处理文件上传</span>
	<span class="token comment">// callback(req, res);</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="接收-excel-上传"><a href="#接收-excel-上传" class="header-anchor">#</a> 接收 Excel 上传</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> multiparty <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multiparty'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">multiparty<span class="token punctuation">.</span>Form</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
form<span class="token punctuation">.</span>uploadDir <span class="token operator">=</span> <span class="token string">'./'</span><span class="token punctuation">;</span> <span class="token comment">// 文件保存路径</span>
form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> filePath <span class="token operator">=</span> files<span class="token punctuation">.</span>file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">;</span>
	<span class="token comment">// TODO 解析Excel</span>
	fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除文件</span>
	<span class="token comment">// TODO 执行爬取任务</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="解析-excel"><a href="#解析-excel" class="header-anchor">#</a> 解析 Excel</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">XLSX</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xlsx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读取临时文件内容</span>
<span class="token keyword">const</span> buf <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wb <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'buffer'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析成工作簿</span>
<span class="token keyword">const</span> rows <span class="token operator">=</span> <span class="token constant">XLSX</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">sheet_to_json</span><span class="token punctuation">(</span>wb<span class="token punctuation">.</span>Sheets<span class="token punctuation">[</span>wb<span class="token punctuation">.</span>SheetNames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把工作簿转成json数组</span>
<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
rows<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">row</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 构建数据源</span>
		list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			id<span class="token operator">:</span> Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 序号</span>
			url<span class="token operator">:</span> row<span class="token punctuation">[</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 链接</span>
			old_title<span class="token operator">:</span> row<span class="token punctuation">[</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 原标题</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在这个方法内，完成了读取 Excel 内容，并取出帖子 url，存放到 list 数组中，为后面的爬取任务做准备</p> <h3 id="爬取基础信息"><a href="#爬取基础信息" class="header-anchor">#</a> 爬取基础信息</h3> <p>循环执行，取出 list 中的 url</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Iconv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'iconv-lite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cheerio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cheerio'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// obj in list</span>

<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
	method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
	encoding<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
	url<span class="token operator">:</span> obj<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 发起请求</span>
<span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> res<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>Iconv<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">'gb2312'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析html（包括编码）</span>
	<span class="token keyword">const</span> titleTxt <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#maxwrap-maintopic div.rconten'</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'.maxtitle'</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取标题</span>
	<span class="token keyword">const</span> desc <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#maxwrap-maintopic div.rconten .conttxt'</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\s/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取详情</span>
	<span class="token keyword">const</span> imgs <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#maxwrap-maintopic div.rconten'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 获取图片数</span>

	<span class="token comment">// 获取帖子id</span>
	<span class="token keyword">const</span> r1 <span class="token operator">=</span> obj<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.html'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> r2 <span class="token operator">=</span> <span class="token punctuation">(</span>r1<span class="token punctuation">[</span>r1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	r2<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// TODO 获取评论数点击数</span>
	<span class="token comment">// getViews(r2[r2.length - 1], obj, callback);</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="爬取-jsonp-信息"><a href="#爬取-jsonp-信息" class="header-anchor">#</a> 爬取 jsonp 信息</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
	method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
	encoding<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
	url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://xxx.xxx.com.cn/Detail/LoadX_Mini?topicId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> res<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> replys <span class="token operator">=</span> result<span class="token punctuation">.</span>topicClicks<span class="token punctuation">.</span>Replys<span class="token punctuation">;</span> <span class="token comment">// 评论数</span>
	<span class="token keyword">const</span> views <span class="token operator">=</span> result<span class="token punctuation">.</span>topicClicks<span class="token punctuation">.</span>Views<span class="token punctuation">;</span> <span class="token comment">// 点击量</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="效-果"><a href="#效-果" class="header-anchor">#</a> 效 果</h2> <p><img src="http://zhkumsg.gitee.io/imagepub/%E7%88%AC%E8%99%AB%E7%BB%93%E6%9E%9C.png" alt="爬虫结果"></p> <h2 id="反爬虫"><a href="#反爬虫" class="header-anchor">#</a> 反爬虫</h2> <p>有爬虫自然就有反爬虫，比如该论坛站点有 1 分钟内最大请求限制，超出这个限制了会强制触发验证码，只有人机交互通过了，才正常响应内容</p> <p><em>原本是没有这个限制的，估计是某段时间请求量井喷，运维检查后才添加的</em></p> <p>解决方法有很多，如伪装请求，但最有效的方法还是使用代理 IP，在触发反爬虫机制前及时切换 IP 去请求，避免被封 IP。</p> <p><strong>然而，后面发现 PC 端的确是做了爬虫限制，可是移动端却没有添加类似的功能，估计是运维的疏忽</strong></p> <h2 id="法律风险"><a href="#法律风险" class="header-anchor">#</a> 法律风险</h2> <div class="language- extra-class"><pre class="language-text"><code>9 月 6 日下午，多位业内人士称，杭州知名大数据服务公司杭州魔蝎数据科技有限公司，疑似被相关执法人员控制，其中一位周姓核心高管人员被警方带走。
</code></pre></div><p>近日技术圈传播的一则新闻，又一家数据公司被调查，很多数据从业者、爬虫开发者发出了&quot;感叹&quot; —— 「爬虫用得好，XX 进得早；数据玩得溜，XX 吃个够」。</p> <p>在 2017 年的一篇文章 <a href="https://www.wdzj.com/zhuanlan/guancha/17-5814-1.html" target="_blank" rel="noopener noreferrer">爬虫凶猛：爬支付宝、爬微信、窃取现金贷放贷数据<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中，指出<em>魔蝎科技</em>存在开发使用恶意爬虫的行为，至于为什么会被查，相信执法部门会给出一个合理的解释。那么在做爬虫的我们是否有点瑟瑟发抖呢，有没有想过怎样才能做一个不触碰红线的爬虫开发者</p> <p><img src="http://zhkumsg.gitee.io/imagepub/%E7%88%AC%E8%99%AB%E7%9A%84%E8%BE%B9%E7%95%8C%E5%9C%A8%E5%93%AA.png" alt="爬虫的边界在哪"></p> <p>如何界定爬虫的合法性，目前没有明文规定，但大量文章、事件、分享和司法案例表名，有三个关键点：<strong>采集途径、采集行为、使用目的</strong>。</p> <h3 id="数据的采集途径"><a href="#数据的采集途径" class="header-anchor">#</a> 数据的采集途径</h3> <p>通过什么途径爬取数据，这个是最需要重视的一点。总体来说，<em>未公开、未经许可、且带有敏感信息的数据</em>，不管是通过什么渠道获得，都是一种不合法的行为。</p> <p>所以在采集这类比较敏感的数据时，最好先查询下相关法律法规，特别是用户个人信息、其他商业平台的信息 等这类信息，寻找一条合适的途径。</p> <h4 id="个人数据"><a href="#个人数据" class="header-anchor">#</a> 个人数据</h4> <p>采集和分析个人信息数据，应该是当下所有互联网都会做的一件事，但是大部分个人数据都是非公开的，想获得必须通过合法途径，可参见『网络安全法』第四十一条：</p> <div class="language- extra-class"><pre class="language-text"><code>网络运营者收集、使用个人信息，应当遵循合法、正当、必要的原则，公开收集、使用规则，明示收集、使用信息的目的、方式和范围，并经被收集者同意...
</code></pre></div><p>也就是必须在提前告知收集的方式、范围、目的，并经过用户授权或同意后，才能采集使用，也就是我们常见的各种网站与 App 的用户协议中关于信息收集的部分。</p> <h4 id="公开数据"><a href="#公开数据" class="header-anchor">#</a> 公开数据</h4> <p>从合法公开渠道，并且不明显违背个人信息主体意愿，都没有什么问题。但如果通过 <em>破解、侵入</em> 等&quot;黑客&quot;手段来获取数据，那也有相关法律等着你：</p> <div class="language- extra-class"><pre class="language-text"><code>刑法第二百八十五条第三款规定的&quot;专门用于侵入、非法控制计算机信息系统的程序、工具&quot;
</code></pre></div><h4 id="违反-robots-协议"><a href="#违反-robots-协议" class="header-anchor">#</a> 违反 Robots 协议</h4> <p>虽然 Robots 协议没有法规强制遵守，但 Robots 协议作为行业约定，在遵循之下会给你带来合法支持。</p> <p>因为 Robots 协议具有指导意义，如果注明 Disallow 就说明是平台明显要保护的页面数据，想爬取之前应该仔细考虑一下。</p> <h3 id="数据的采集行为"><a href="#数据的采集行为" class="header-anchor">#</a> 数据的采集行为</h3> <p>使用技术手段应该懂得克制，一些容易对服务器和业务造成干扰甚至破坏的行为，应当充分衡量其承受能力，毕竟不是每家都是 BAT 级。</p> <h4 id="高并发压力"><a href="#高并发压力" class="header-anchor">#</a> 高并发压力</h4> <p>做技术经常专注于优化，爬虫开发也是如此，想尽各种办法增加并发数、请求效率，但高并发带来的近乎 DDOS 的请求，如果对对方服务器造成压力，影响了对方正常业务，那就应该警惕了。</p> <p>如果一旦导致严重后果，后果参见：</p> <div class="language- extra-class"><pre class="language-text"><code>《刑法》第二百八十六条还规定，违反国家规定，对计算机信息系统功能进行删除、修改、增加、干扰，造成计算机信息系统不能正常运行，后果严重的，构成犯罪
</code></pre></div><p>所以请爬取的时候，即使没有反爬限制，也不要肆无忌惮地开启高并发，掂量一下对方服务器的实力。</p> <h4 id="影响正常业务"><a href="#影响正常业务" class="header-anchor">#</a> 影响正常业务</h4> <p>除了高并发请求，还有一些影响业务的情况，常见的比如抢单，会影响正常用户的体验。</p> <h3 id="数据的使用目的"><a href="#数据的使用目的" class="header-anchor">#</a> 数据的使用目的</h3> <p>数据使用目的同样是一大关键，就算你通过合法途径采集的数据，如果对数据没有正确的使用，同样会存在不合法的行为。</p> <h4 id="超出约定的使用"><a href="#超出约定的使用" class="header-anchor">#</a> 超出约定的使用</h4> <p>一种情况是公开收集的数据，但没有遵循之前告知的使用目的，比如用户协议上说只是分析用户行为，帮助提高产品体验，结果变成了出售用户画像数据。</p> <p>还有一种情况，是有知识产权、著作权的作品，可能会允许你下载或引用，但明显标注了使用范围，比如不能转载、不能用于商业行为等，更不能去盗用，这些都是有法律明文保护，所以要注意使用。</p> <h4 id="出售个人信息"><a href="#出售个人信息" class="header-anchor">#</a> 出售个人信息</h4> <p>关于出售个人信息，千万不要做，是法律特别指出禁止的，参见：</p> <div class="language- extra-class"><pre class="language-text"><code>根据《最高人民法院 最高人民检察院关于办理侵犯公民个人信息刑事案件适用法律若干问题的解释》第五条规定，对&quot;情节严重&quot;的解释...
</code></pre></div><h4 id="不正当商业行为"><a href="#不正当商业行为" class="header-anchor">#</a> 不正当商业行为</h4> <p>如果将竞品公司的数据，作为自己公司的商业目的，这就可能存在构成不正当商业竞争，或者是违反知识产权保护。</p> <p>这种情况在目前涉及爬虫的商业诉讼案中比较常见，之前比较知名的案件，&quot;车来了&quot; App 抓取其竞品 &quot;酷米客&quot; 的公交车数据，并展示在自己的产品上：</p> <div class="language- extra-class"><pre class="language-text"><code>虽然公交车作为公共交通工具，其实时运行路线、运行时间等信息仅系客观事实，但当此类信息经过人工收集、分析、编辑、整合并配合GPS精确定位，作为公交信息查询软件的后台数据后，此类信息便具有了实用性并能够为权利人带来现实或潜在、当下或将来的经济利益，已经具备无形财产的属性。元光公司利用网络爬虫技术大量获取并且无偿使用谷米公司&quot;酷米客&quot;软件的实时公交信息数据的行为，实为一种&quot;不劳而获&quot;、&quot;食人而肥&quot;的行为，构成不正当竞争。
</code></pre></div><h3 id="「爬虫法」即将出台"><a href="#「爬虫法」即将出台" class="header-anchor">#</a> 「爬虫法」即将出台</h3> <div class="language- extra-class"><pre class="language-text"><code>2019年5月28日零点，国家互联网信息办公室发布了《数据安全管理办法》征求意见稿。
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1/13/2020, 3:59:17 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3328e81d.js" defer></script><script src="/assets/js/2.c715c0f2.js" defer></script><script src="/assets/js/55.5fb2a242.js" defer></script>
  </body>
</html>
