(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{159:function(t,a,s){"use strict";s.r(a);var n=s(0),r=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"pm2-部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pm2-部署"}},[t._v("#")]),t._v(" PM2 部署")]),t._v(" "),s("p",[t._v("对于线上项目，如果直接通过 node app 来启动，如果报错了可能直接停止导致整个服务崩溃")]),t._v(" "),s("p",[t._v("一般监控 node 有几种方案。")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("supervisor: 一般用作开发环境的使用。")])]),t._v(" "),s("li",[s("p",[t._v("forever: 管理多个站点，一般每个站点的访问量不大的情况，不需要监控。")])]),t._v(" "),s("li",[s("p",[t._v("PM2: 网站的访问量比较大，需要完整的监控页面。")])])]),t._v(" "),s("h2",{attrs:{id:"部-署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部-署"}},[t._v("#")]),t._v(" 部 署")]),t._v(" "),s("p",[t._v("本项目使用 pm2 部署，执行下面命令即可")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run start\n")])])]),s("h3",{attrs:{id:"准-备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准-备"}},[t._v("#")]),t._v(" 准 备")]),t._v(" "),s("p",[t._v("在正式部署前还需要做以下准备")]),t._v(" "),s("ol",[s("li",[t._v("生成 dll（如果依赖没有变，可跳过此步骤）")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run dll\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("生成静态资源")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build\n")])])]),s("h2",{attrs:{id:"pm2-的主要特性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pm2-的主要特性"}},[t._v("#")]),t._v(" PM2 的主要特性")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("内建负载均衡（使用 Node cluster 集群模块）")])]),t._v(" "),s("li",[s("p",[t._v("后台运行")])]),t._v(" "),s("li",[s("p",[t._v("0 秒停机重载")])]),t._v(" "),s("li",[s("p",[t._v("具有 Ubuntu 和 CentOS 的启动脚本")])]),t._v(" "),s("li",[s("p",[t._v("停止不稳定的进程（避免无限循环）")])]),t._v(" "),s("li",[s("p",[t._v("控制台检测")])]),t._v(" "),s("li",[s("p",[t._v("提供 HTTP API")])]),t._v(" "),s("li",[s("p",[t._v("远程控制和实时的接口 API ( Nodejs 模块,允许和 PM2 进程管理器交互 )")])])]),t._v(" "),s("h2",{attrs:{id:"installation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#installation"}},[t._v("#")]),t._v(" Installation")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" pm2 -g\n")])])]),s("h2",{attrs:{id:"常用命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常用命令"}},[t._v("#")]),t._v(" 常用命令")]),t._v(" "),s("h3",{attrs:{id:"启动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启动"}},[t._v("#")]),t._v(" 启动")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pm2 start\n")])])]),s("h3",{attrs:{id:"查看运行状态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看运行状态"}},[t._v("#")]),t._v(" 查看运行状态")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pm2 show "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("appname"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h3",{attrs:{id:"查看进程列表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看进程列表"}},[t._v("#")]),t._v(" 查看进程列表")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pm2 list\n")])])]),s("h3",{attrs:{id:"查看日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看日志"}},[t._v("#")]),t._v(" 查看日志")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pm2 logs\n")])])]),s("h3",{attrs:{id:"开启页面监控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开启页面监控"}},[t._v("#")]),t._v(" 开启页面监控")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pm2 web\n")])])]),s("p",[s("em",[t._v("默认在 9615 端口开启")]),t._v(" "),s("a",{attrs:{href:"http://localhost:9615",target:"_blank",rel:"noopener noreferrer"}},[t._v("点我"),s("OutboundLink")],1),t._v("，如需性能监控可开启此功能")]),t._v(" "),s("h3",{attrs:{id:"重启进程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重启进程"}},[t._v("#")]),t._v(" 重启进程")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pm2 restart "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("appname"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h3",{attrs:{id:"停止进程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#停止进程"}},[t._v("#")]),t._v(" 停止进程")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pm2 stop "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("appname"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h3",{attrs:{id:"删除进程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#删除进程"}},[t._v("#")]),t._v(" 删除进程")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pm2 delete "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("appname"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("或")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ pm2 delete all\n")])])]),s("h3",{attrs:{id:"负载均衡"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡"}},[t._v("#")]),t._v(" 负载均衡")]),t._v(" "),s("p",[t._v("未了解")]),t._v(" "),s("h3",{attrs:{id:"配置文件-选"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置文件-选"}},[t._v("#")]),t._v(" 配置文件[选]")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 名称任意，按照个人习惯来")]),t._v("\nmodule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tapps"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tname"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kaifazhe'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 应用名称")]),t._v("\n\t\t\tscript"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./build/server.js'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 启动文件地址")]),t._v("\n\t\t\tcwd"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 当前工作路径")]),t._v("\n\t\t\twatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 监控变化的目录，一旦变化，自动重启")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'src'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'build'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tignore_watch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 忽视这些目录的变化")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node_modules'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'logs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'public'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tnode_args"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--harmony'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// node的启动模式")]),t._v("\n\t\t\tenv"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'development'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置运行环境，此时process.env.NODE_ENV的值就是development")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ORIGIN_ADDR")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://www.yoduao.com'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tenv_production"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tout_file"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./logs/out.log'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 普通日志路径")]),t._v("\n\t\t\terror_file"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./logs/err.log'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误日志路径")]),t._v("\n\t\t\tmerge_logs"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tlog_date_format"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'YYYY-MM-DD HH:mm Z'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"开机自启"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开机自启"}},[t._v("#")]),t._v(" 开机自启")]),t._v(" "),s("p",[t._v("运行 "),s("code",[t._v("pm2 startup")]),t._v("，即在/etc/init.d/目录下生成 pm2-root 的启动脚本，且自动将 pm2-root 设为服务。")]),t._v(" "),s("p",[t._v("运行 "),s("code",[t._v("pm2 save")]),t._v("，会将当前 pm2 所运行的应用保存在/root/.pm2/dump.pm2 下，当开机重启时，运行 pm2-root 服务脚本，并且到/root/.pm2/dump.pm2 下读取应用并启动。")])])}),[],!1,null,null,null);a.default=r.exports}}]);