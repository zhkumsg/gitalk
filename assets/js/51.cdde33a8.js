(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{173:function(t,s,a){"use strict";a.r(s);var e=a(0),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"异常捕获与上报"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#异常捕获与上报"}},[t._v("#")]),t._v(" 异常捕获与上报")]),t._v(" "),a("p",[t._v("异常捕获与上报是异常监控的前提，了解并做好了异常数据的收集和分析才能实现一个完善的错误响应和处理机制，最终达成数据可视化, 后面将介绍如何在已有项目上集成 Sentry")]),t._v(" "),a("h2",{attrs:{id:"前-言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前-言"}},[t._v("#")]),t._v(" 前 言")]),t._v(" "),a("p",[t._v("正所谓百密一疏，一个经过了大量测试及联调的项目在有些时候还是会有十分隐蔽的 bug 存在，这种复杂而又不可预见性的问题唯有通过完善的监控机制才能有效的减少其带来的损失，因此对于直面用户的前端而言，异常捕获与上报是至关重要的。")]),t._v(" "),a("p",[t._v("对服务端来说还好, 可以通过日志的形式来记录信息, 而对于前端而言, 异常都是发生在客户端的, 必须得通过上报的形式才可以被程序员所得知")]),t._v(" "),a("p",[t._v("为了让前端也能和后端一样，需要将线上的 JavaScript 代码监控起来，当用户端浏览器出现异前端第一时间被通知到(甚至邮件实时推送)")]),t._v(" "),a("h3",{attrs:{id:"采集哪些数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#采集哪些数据"}},[t._v("#")]),t._v(" 采集哪些数据")]),t._v(" "),a("p",[t._v("主要原则就是避开用户敏感字段，采集浏览器版本、操作系统版本、报错的 msg 信息等")]),t._v(" "),a("h3",{attrs:{id:"如何采集错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何采集错误"}},[t._v("#")]),t._v(" 如何采集错误")]),t._v(" "),a("p",[t._v("前端错误大体上可以分成两类，")]),t._v(" "),a("ul",[a("li",[t._v("代码执行的错误")]),t._v(" "),a("li",[t._v("资源加载的错误(包括但不限于 http 异常)")])]),t._v(" "),a("p",[t._v("下面是具体的捕获方式")]),t._v(" "),a("ul",[a("li",[t._v("使用 try catch")]),t._v(" "),a("li",[t._v("使用 window.onerror")]),t._v(" "),a("li",[t._v("框架集成的错误中间件")])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://zhkumsg.gitee.io/imagepub/775838-20180323224456954-1853086677.png",alt:"异常上报"}})]),t._v(" "),a("h3",{attrs:{id:"如何上报错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何上报错误"}},[t._v("#")]),t._v(" 如何上报错误")]),t._v(" "),a("ul",[a("li",[t._v("使用 ajax 上报")]),t._v(" "),a("li",[t._v("使用 image 上报")])]),t._v(" "),a("p",[t._v("一般来说，大厂都是采用利用 image 对象的方式上报错误的；使用图片发送 get 请求，上报信息，由于浏览器对图片有缓存，同样的请求，图片只会发送一次，避免重复上报。")]),t._v(" "),a("h2",{attrs:{id:"选择监控方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#选择监控方法"}},[t._v("#")]),t._v(" 选择监控方法")]),t._v(" "),a("ul",[a("li",[t._v("自行搭建")]),t._v(" "),a("li",[t._v("Sentry")]),t._v(" "),a("li",[t._v("Fundebug")]),t._v(" "),a("li",[t._v("Bugsnag")]),t._v(" "),a("li",[t._v("Better JS")])]),t._v(" "),a("p",[t._v("由于需要监听 Vue 项目和 nodejs 项目, 且监听服务需要跑在自己的服务器上, 只有自行搭建, Sentry 和 Better JS 三个可选, 但对于 vue 项目, 代码已经经过压缩混淆了, 所以监控方案需要具备解析 Map 的功能, 出于开发成本和集成难度的考虑, 最终决定使用 "),a("code",[t._v("Sentry")])]),t._v(" "),a("p",[a("a",{attrs:{href:"https://sentry.io/welcome/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Sentry 官网"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"搭建-sentry-服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#搭建-sentry-服务"}},[t._v("#")]),t._v(" 搭建 Sentry 服务")]),t._v(" "),a("p",[t._v("Sentry 是一个开源的实时错误追踪系统，可以帮助开发者实时监控并修复异常问题。它主要专注于持续集成、提高效率并且提升用户体验。Sentry 分为服务端和客户端 SDK，前者可以直接使用它家提供的在线服务，也可以本地自行搭建；后者提供了对多种主流语言和框架的支持，包括 React、Angular、Node、Django、RoR、PHP、Laravel、Android、. NET、JAVA 等。同时它可提供了和其他流行服务集成的方案，例如 GitHub、GitLab、bitbuck、heroku、slack、Trello 等。目前公司的项目也都在逐步应用上 Sentry 进行错误日志管理。")]),t._v(" "),a("p",[t._v("Sentry 本身是基于 Django 开发的，而且也依赖到其他的如 Postgresql、 Redis 等组件，所以一般有两种途径进行安装：")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://docs.sentry.io/server/installation/docker/",target:"_blank",rel:"noopener noreferrer"}},[t._v("通过 Docker"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.sentry.io/server/installation/python/",target:"_blank",rel:"noopener noreferrer"}},[t._v("用 Python 搭建"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("下面介绍如何使用 "),a("code",[t._v("docker")]),t._v(" 安装")]),t._v(" "),a("h3",{attrs:{id:"克隆-github-项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#克隆-github-项目"}},[t._v("#")]),t._v(" 克隆 Github 项目")]),t._v(" "),a("p",[t._v("github 上有个开源项目用于部署 Sentry, 首先我们需要先把它克隆到本地")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/getsentry/onpremise.git\n")])])]),a("p",[a("em",[t._v("如果没有安装 git 环境, 也可以下载项目到本地 "),a("a",{attrs:{href:"https://github.com/getsentry/onpremise",target:"_blank",rel:"noopener noreferrer"}},[t._v("点击查看"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("克隆完成后, 我们进入 "),a("code",[t._v("onpremise")]),t._v(" 文件夹")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" onpremise\n")])])]),a("p",[t._v("项目结构")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("┌── config.yml\n├── Dockerfile # docker 配置\n├── sentry.conf.py # sentry配置\n├── test.sh # 测试脚本\n├── install.sh # 安装脚本\n├── Makefile # 编辑\n├── requirements.txt\n└── docker-compose.yml # docker-compose相关\n")])])]),a("h3",{attrs:{id:"搭建-docker-环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#搭建-docker-环境"}},[t._v("#")]),t._v(" 搭建 docker 环境")]),t._v(" "),a("p",[a("em",[t._v("node 和 npm 环境搭建不再阐述")])]),t._v(" "),a("p",[t._v("因为我们使用简单的 docker 一键部署方式, 所谓我们当然是需要配置好 docker 环境的, 下面以 Ubuntu 为例")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" docker.io docker-compose\n")])])]),a("p",[a("em",[t._v("如果没有 apt 包管理工具,也可以使用 yum 下载")])]),t._v(" "),a("p",[t._v("安装 docker 相关服务, "),a("code",[t._v("docker.io")]),t._v(" 和 "),a("code",[t._v("docker-compose")])]),t._v(" "),a("h3",{attrs:{id:"执行安装脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#执行安装脚本"}},[t._v("#")]),t._v(" 执行安装脚本")]),t._v(" "),a("p",[t._v("这就是我们前面提到的 "),a("code",[t._v("onpremise/install.sh")]),t._v(" , 它是一段 shell 脚本, 执行后会自动安装 Sentry")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" ./install.sh\n")])])]),a("p",[t._v("正常执行后, 等待一段时间, 会自动安装服务")]),t._v(" "),a("p",[t._v("在安装的后部分, 会提示输入超级用户的 "),a("code",[t._v("账号和密码(以及确认密码)")]),t._v(" , 这个账号将作为 Sentry 的超级管理员")]),t._v(" "),a("h3",{attrs:{id:"启动-sentry"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动-sentry"}},[t._v("#")]),t._v(" 启动 Sentry")]),t._v(" "),a("p",[t._v("安装完成后, 按照提示运行")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" docker-compose up -d\n")])])]),a("p",[t._v("如无意外, 将在 9000 端口启动 Sentry 服务 "),a("a",{attrs:{href:"http://localhost:9000",target:"_blank",rel:"noopener noreferrer"}},[t._v("点击打开"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("img",{attrs:{src:"http://zhkumsg.gitee.io/imagepub/Sentry.png",alt:"sentry"}})]),t._v(" "),a("h3",{attrs:{id:"创建项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建项目"}},[t._v("#")]),t._v(" 创建项目")]),t._v(" "),a("p",[t._v("成功登录 Sentry 后, 在 Project 菜单中找到 add new 按钮, 选择创建一个项目")]),t._v(" "),a("p",[t._v("这时候按照提示, 选择项目目标语言, 最后会拿到一段 dsn 字符串, 如")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("http://1b036df22e114db78f99770cf9be29b0@localhost:9000/3\n")])])]),a("p",[t._v("按照页面提示, 再去代码中添加相关内容即可完成异常监控")]),t._v(" "),a("h2",{attrs:{id:"nodejs-项目集成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nodejs-项目集成"}},[t._v("#")]),t._v(" nodejs 项目集成")]),t._v(" "),a("p",[t._v("按照官网文档, 我们只需要作两步就可以接入 Sentry 了")]),t._v(" "),a("ol",[a("li",[t._v("安装依赖")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" @sentry/node@5.5.0 --save\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("初始化服务")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// app.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Sentry "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@sentry/node'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nSentry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tdsn"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://1b036df22e114db78f99770cf9be29b0@localhost:9000/3'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("这就完成了 Sentry 的接入(注意这里的 dsn)")]),t._v(" "),a("p",[t._v("如果是 koa 项目, 还可以在中间件中进一步监听异常")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// app.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\napp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ctx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tSentry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("withScope")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("scope")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tscope"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventProcessor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" Sentry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Handlers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\tSentry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("captureException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"vue-项目集成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vue-项目集成"}},[t._v("#")]),t._v(" vue 项目集成")]),t._v(" "),a("p",[t._v("同样的, 在 vue 下也是两步就可以完成集成, 不过需要注意的是, 需要考虑是否需要新建多一个 Sentry 项目, 如果希望 nodejs 的异常与 vuejs 的异常分离的话, 可以按照前面创建项目的教程新创一个 vuejs 的项目")]),t._v(" "),a("ol",[a("li",[t._v("安装依赖")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" @sentry/browser  @sentry/integrations --save\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("初始化 Sentry")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// main.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Vue "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'vue'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Sentry "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@sentry/browser'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Integrations "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@sentry/integrations'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nSentry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tdsn"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://1b036df22e114db78f99770cf9be29b0@localhost:9000/3'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tintegrations"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Integrations"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Vue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Vue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" attachProps"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("到这里就完成了 nodejs 和 vuejs 的异常捕获以及上报")]),t._v(" "),a("p",[a("em",[t._v("因为 vue 项目大多是使用 webpack 构建出来的，代码已经被压缩混淆了，所以上线后的异常是没办法精确到具体行号，如果需要精确的错误信息，请看下面")])]),t._v(" "),a("h2",{attrs:{id:"更进一步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#更进一步"}},[t._v("#")]),t._v(" 更进一步")]),t._v(" "),a("h4",{attrs:{id:"区分开发环境与生产环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#区分开发环境与生产环境"}},[t._v("#")]),t._v(" 区分开发环境与生产环境")]),t._v(" "),a("p",[t._v("我们真正关注的其实只有生产环境的异常，对开发环境的异常我们都是立马解决的，所以对于异常监控，我们一般都需要对环境进行区分，下面有两种方式")]),t._v(" "),a("ol",[a("li",[t._v("生产环境才上报")])]),t._v(" "),a("p",[t._v("这是最简单也是最方便的，只在生产环境下时才上报异常，通过"),a("code",[t._v("process.env.NODE_ENV")]),t._v("判断即可")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化nodejs版错误监控服务")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tSentry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" dsn"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" nodeDsn "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("两套异常项目")])]),t._v(" "),a("p",[t._v("如果也需要监控开发环境的（当然得和生产环境的异常分开），我们一般是通过创建两套 sentry 项目，分别监控")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化nodejs版错误监控服务")]),t._v("\nSentry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" dsn"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" nodePordDsn "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" nodeDevDsn "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"上传-source-map-精确定位异常"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上传-source-map-精确定位异常"}},[t._v("#")]),t._v(" 上传 source map 精确定位异常")]),t._v(" "),a("p",[t._v("前面提到，vue 项目（包括其他用 webpack 构建出来的项目），监听到的异常并不完整，难以精确到具体代码，所以我们需要上传 "),a("code",[t._v("source map")]),t._v(" 文件到 sentry")]),t._v(" "),a("p",[t._v("上传 "),a("code",[t._v("source ma")]),t._v(" 前\n"),a("img",{attrs:{src:"http://zhkumsg.gitee.io/imagepub/20190930095747.png",alt:"before"}})]),t._v(" "),a("p",[t._v("上传 "),a("code",[t._v("source map")]),t._v(" 后\n"),a("img",{attrs:{src:"http://zhkumsg.gitee.io/imagepub/20190930095812.png",alt:"after"}})]),t._v(" "),a("p",[t._v("很明显，上传 source map 后 Sentry 定位的更加精确了")]),t._v(" "),a("p",[t._v("下面介绍如何上传 webpack 项目构建的 source map")]),t._v(" "),a("h4",{attrs:{id:"选择上传方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#选择上传方式"}},[t._v("#")]),t._v(" 选择上传方式")]),t._v(" "),a("p",[t._v("上传方式有两种，分别是"),a("code",[t._v("通过@sentry/cli脚手架人工上传")]),t._v("和"),a("code",[t._v("通过webpack插件自动上传")])]),t._v(" "),a("p",[t._v("链接："),a("a",{attrs:{href:"https://www.npmjs.com/package/@sentry/cli",target:"_blank",rel:"noopener noreferrer"}},[t._v("@sentry/cli"),a("OutboundLink")],1),t._v(" 、 "),a("a",{attrs:{href:"https://www.npmjs.com/package/@sentry/webpack-plugin",target:"_blank",rel:"noopener noreferrer"}},[t._v("@sentry/webpack-plugin"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("既然我们是使用 webpack 构建的，"),a("em",[t._v("选用 webpack 插件")]),t._v(" 自然是最合适的了")]),t._v(" "),a("h4",{attrs:{id:"生成-source-map"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生成-source-map"}},[t._v("#")]),t._v(" 生成 source map")]),t._v(" "),a("p",[t._v("在 webpack 中，"),a("code",[t._v("devtool")]),t._v("属性有四个值，可以配置生成映射文件帮助我们调试代码")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}},[t._v("devtool")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("source-map")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("eval-source-map")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("cheap-module-source-map")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("cheap-module-eval-source-map")])])])]),t._v(" "),a("p",[t._v("这里选用 "),a("code",[t._v("source-map")]),t._v(" 即可")]),t._v(" "),a("h4",{attrs:{id:"生成-sentry-配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生成-sentry-配置文件"}},[t._v("#")]),t._v(" 生成 sentry 配置文件")]),t._v(" "),a("p",[t._v("既然需要 webpack 中上传 map 映射文件，那么就需要明确说明需要上传到哪个服务器、哪个项目下")]),t._v(" "),a("p",[a("code",[t._v("@sentry/webpack-plugin")]),t._v("插件会自动读取项目根目录的 "),a("code",[t._v(".sentryclirc")]),t._v(" 文件")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("首先我们在项目根目录创建 "),a("code",[t._v(".sentryclirc")]),t._v(" 文件")])]),t._v(" "),a("li",[a("p",[t._v("再去 sentry 网站，侧边栏 / 用户 / API keys / Auth Tokens ，创建一个 token")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://zhkumsg.gitee.io/imagepub/20190930103714.png",alt:"token"}})]),t._v(" "),a("p",[t._v("这时候需要勾选"),a("code",[t._v("project:write")]),t._v("，生成后进会得到一段 token 字符串，这是将来上传 map 文件的凭证")]),t._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[a("p",[t._v("确定项目名称，需要知道 sentry 上对应的 dsn 的那个项目名称")])]),t._v(" "),a("li",[a("p",[t._v("确定组织名称，在 Settings / General 中可以看到")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://zhkumsg.gitee.io/imagepub/20190930104236.png",alt:"org"}})]),t._v(" "),a("p",[t._v("默认是 "),a("code",[t._v("sentry")])]),t._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[t._v("编写.sentryclirc")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[defaults]\nurl = 你部署的sentry地址\norg = 前面拿到在组织名\nproject = 前面拿到是项目名（不是代码项目，是sentry服务上的项目名）\n\n[auth]\ntoken = 前面拿到的token字符串\n")])])]),a("h4",{attrs:{id:"实例化插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实例化插件"}},[t._v("#")]),t._v(" 实例化插件")]),t._v(" "),a("p",[t._v("配置好信息后，我们可以做自动上传部分了")]),t._v(" "),a("p",[t._v("安装依赖")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" @sentry/webpack-plugin --save-dev\n")])])]),a("p",[t._v("实例化")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// prod.config.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'path'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" SentryPlugin "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@sentry/webpack-plugin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nplugins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SentryPlugin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// map文件所在文件夹")]),t._v("\n        include"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../dist'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("这时候再执行 "),a("code",[t._v("npm run build")]),t._v(" 构建命令，就会自动上传 map 文件了")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://zhkumsg.gitee.io/imagepub/20190930105144.png",alt:"upload"}})]),t._v(" "),a("h4",{attrs:{id:"注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),a("ol",[a("li",[t._v("构建错误")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v(" ERROR in Sentry CLI Plugin: Command failed: E:\\xxx\\xxx\\node_modules\\@sentry\\cli\\sentry-cli.exe releases new claimform@1.0.3\n\nerror: project not found\n\nAdd --log-level=[info|debug] or export SENTRY_LOG_LEVEL=[info|debug] to see more output.\nPlease attach the full debug log to all bug reports.\n")])])]),a("p",[t._v("这往往是你的 1"),a("code",[t._v(".sentryclirc")]),t._v(" 配错了，"),a("em",[t._v("检查一下 org 和 project 信息")])]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("配置错误")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("ERROR in Sentry CLI Plugin: Command failed: E:\\xxx\\xxx\\node_modules\\@sentry\\cli\\sentry-cli.exe releases new claimform@1.0.3\n\nerror: project not found\n")])])]),a("p",[t._v("检查一下 sentry 配置文件名是否写错 "),a("strong",[t._v(".sentryclirc")])]),t._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[t._v("map 错误")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("~/static/js/app.xxxxxxxxxxx.js (no sourcemap ref)\n- warning: could not determine a source map reference (Could not auto-detect referenced sourcemap for ~/static/js/app.xxxxxxxxx.js.)\n")])])]),a("p",[t._v("检查一下 devtool 是否开启了 source map")]),t._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[t._v("http status 413")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("sentry reported an error: unknown error (http status: 413)\n")])])]),a("p",[t._v("文件上传大小超过限制，检查一下是否 sentry 服务是否用了反向代理，如 nginx，修改文件大小限制")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /etc/nginx/nginx.conf\n")])])]),a("p",[t._v("在 http 字段下修改")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("client_max_body_size 20M; # 修改到20M或更大\n")])])]),a("p",[t._v("重启 nginx")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" nginx restart\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);