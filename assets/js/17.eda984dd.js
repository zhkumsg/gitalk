(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{197:function(s,a,t){"use strict";t.r(a);var e=t(0),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"mysql安全防范"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql安全防范"}},[s._v("#")]),s._v(" mysql安全防范")]),s._v(" "),t("p",[s._v("近日服务器收到攻击，数据库被清空并插入了一个表，内容如下：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"left"}},[s._v("warning")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("bitcoin_address")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("email")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("To recover your lost Database and avoid leaking it: Send us 0.1 Bitcoin (BTC) to our Bitcoin address 1J6jLduCXbPyxt5EMTs7iHwdafANy4ThJc and contact us by Email with your Server IP or Domain name and a Proof of Payment. If you are unsure if we have your data, contact us and we will send you a proof. Your Database is downloaded and backed up on our servers. Backups that we have right now: xxx,xxx,xxx . If we dont receive your payment in the next 10 Days, we will make your database public or use them otherwise.")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("1J6jLduCXbPyxt5EMTs7iHwdafANy4ThJc")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("admin@yourdatabase.biz")])])])]),s._v(" "),t("h4",{attrs:{id:"紧急处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#紧急处理"}},[s._v("#")]),s._v(" 紧急处理")]),s._v(" "),t("p",[s._v("造成的原因因为mysql账号密码被暴力破解和允许远程访问，需要做一些紧急处理")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("禁用远程")]),s._v("\n为了方便，开放允许远程连接，而且没加ip限制，导致黑客有机可乘。所以我们现在要把一切远程连接关闭。\n"),t("code",[s._v("本机登陆")])])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("// 服务器中国登陆数据库\n$ mysql -u 你的账号 -p\n$ 你的密码\n")])])]),t("p",[t("code",[s._v("查看用户")]),s._v("\n有一个特殊的数据库，数据库名为mysql，表名为user，它存储了服务器数据库有用户信息和访问权限。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("// 选用mysql系统表\n$ use mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("// 查询全部的用户和host\n$ "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" user,host form user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("code",[s._v("host")]),s._v("为允许访问的主机地址,"),t("code",[s._v("'%")]),s._v("代表全部允许，如果发现"),t("code",[s._v("host")]),s._v("的信息为"),t("code",[s._v("%")]),s._v("，那这就是问题所在了，把它全删了。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ delete from user where "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("这时候任何远程访问都会被禁止，无法在本机外访问了。\n刷新一下缓存，让配置生效")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ flush privileges"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[t("strong",[s._v("删除黑客账号")]),s._v("\n作为一个专业的黑客，自然会给自己留后路，比如偷偷加一个数据库账号，所以我们要还要查一下用户表。")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" user from user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("如果发现不认识的账号，一定要删了，如只保留根角色")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("// 删除一切非根用户\n$ delete from user where user "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("除了这一步之外，我们还需要去"),t("code",[s._v("db表")]),s._v("相应删除")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("// 删除一切非根用户\n$ delete from db where user "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("同样记得刷新缓存，让配置生效")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ flush privileges"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("ol",{attrs:{start:"3"}},[t("li",[t("strong",[s._v("修改密码")]),s._v("\n尽管前面已经禁用了远程，可是密码已经泄露了，终究不安全，所以我们还要再去改密码。\n还是在系统user表中，有一个password字段，它存储着用户的密码，不过是加密后的，更新的时候需要用系统方法"),t("code",[s._v("password()")]),s._v("。这里已更新root账号的为例")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("// 更新密码\n$ update user "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" password "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'你的新密码'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("新密码一定要复杂，可以考虑闭着眼睛敲（记得复制出来，要不忘了）。\n更新完后还是记得更新缓存（当然可以最后再刷新缓存）。\n4. "),t("strong",[s._v("修改端口")]),s._v("\nmysql默认端口是3306，黑客随便试一下就可以发现了，我们应该修改一下数据库的端口。（尽管还可以进行端口扫描，可是猜不到也没作用）\n首先我们在mysql环境下查询一下当前所用的端口是什么")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ show global variables like "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'port'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n")])])]),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"center"}},[s._v("Variable_name")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("port")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("port")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("3306")])])])]),s._v(" "),t("p",[s._v("退出mysql命令行模式。\n如果我们计划把端口改成3305，先检查一下端口是否被占用")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("netstat")]),s._v(" -tunlp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3305")]),s._v("\n")])])]),t("p",[s._v("如果没有任何输出那就证明没有被占用。\n紧接着我们打开mysql的配置文件，在/etc/my.cnf。\n修改3306端口为一个新的端口")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/my.cnf\n")])])]),t("blockquote",[t("p",[s._v("[mysqld]\nport=3305")])]),s._v(" "),t("p",[s._v("如果"),t("code",[s._v("[mysqld]")]),s._v("下没有"),t("code",[s._v("port")]),s._v("参数，加一个即可。\n保存退出vim。")]),s._v(" "),t("p",[s._v("然后我们重启mysql服务")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ systemctl restart mysqld\n")])])]),t("p",[s._v("是"),t("code",[s._v("mysqld")]),s._v("，不是"),t("code",[s._v("mysql")]),s._v("。\n然后发现3306已经连不上了，需要用新端口才可以。")]),s._v(" "),t("ol",{attrs:{start:"4"}},[t("li",[t("strong",[s._v("重置数据")]),s._v("\n信息泄露了终究不安全，不过我所泄露的信息都是一些测试数据，关系不大，我重置一下就可以了。")])]),s._v(" "),t("hr"),s._v(" "),t("h4",{attrs:{id:"自定义"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自定义"}},[s._v("#")]),s._v(" 自定义")]),s._v(" "),t("p",[s._v("上述操作会导致远程无法连接，如果又想安全又想方便，可以通过限制ip的方式，首先我们创建一个用户，给该用户分配有限的权限，然后设置一个复杂的密码，最后加上ip限制就可以了，下面是详细做法。")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("新建用户")]),s._v("\n使用root登录数据库后，进入到系统mysql表。假设我们创建zhangsan用户，密码是123456")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ create  user  zhangsan  identified  by  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("如果创建成功，会默认创建一个"),t("code",[s._v("%")]),s._v("ip限制的用户，如果创建失败，先删除用户再创建即可。")]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[t("strong",[s._v("分配权限")]),s._v("\n创建完"),t("code",[s._v("zhangsan")]),s._v("用户后，我们还需要为其分配数据库，处于安全考虑，一般只分配部分数据库，比如把ABC数据库的全部权限都分配给zhangsan，执行如下：")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ grant all privileges on ABC.* to zhangsan@"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),s._v(" identified by "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[t("code",[s._v("ABC.*")]),s._v("代表ABC数据库下的全部权限\n"),t("code",[s._v("%")]),s._v("为默认不限制host。")]),s._v(" "),t("p",[s._v("此时zhangsan用户只能查看到ABC数据库下的\n的内容。\n3. "),t("strong",[s._v("限制ip")]),s._v("\n上两步都提到，host还是默认的%，不加限制，我们当然需要添加ip限制，更新一下user即可。")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ update user "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'你的ip'")]),s._v(" where user "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zhangsan'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("此时只允许指定ip通过。")]),s._v(" "),t("ol",{attrs:{start:"4"}},[t("li",[t("strong",[s._v("刷新缓存")]),s._v("\n既然修改了数据库配置，那就需要刷新使得配置生效。")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ flush privileges"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("hr"),s._v(" "),t("h4",{attrs:{id:"建议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#建议"}},[s._v("#")]),s._v(" 建议")]),s._v(" "),t("p",[s._v("针对此事项，建议做以下调整，以防范黑客攻击：")]),s._v(" "),t("p",[s._v("1、服务器的管理员密码具备一定复杂度，建议使用字母、数字、字符组合的密码。")]),s._v(" "),t("p",[s._v("2、服务器关闭远程访问（或关闭外网的远程访问），调整远程访问默认的端口号。")]),s._v(" "),t("p",[s._v("3、mysql的root用户密码具备一定复杂度，建议使用字母、数字、字符组合的密码。")]),s._v(" "),t("p",[s._v("4、mysql不允许任意远程端连接，建议仅对协同系统所在的IP地址放开连接。")]),s._v(" "),t("p",[s._v("5、mysql不使用默认的3306端口，建议修改为其他端口。（mysql的配置文件：Windows为my.ini、Linux为my.cnf，修改其端口号）")]),s._v(" "),t("p",[s._v("6、mysql设置定时备份，并将数据备份包备份在异机（或异地）。")])])}),[],!1,null,null,null);a.default=n.exports}}]);